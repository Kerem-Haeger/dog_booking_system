{% extends 'core/base.html' %}

{% block title %}Client Dashboard - Dog Booking System{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}?v=6.0">
<link rel="stylesheet" href="{% static 'core/css/appointments.css' %}?v=6.0">
{% endblock %}

{% block content %}
<div class="client-dashboard">
    <!-- Main Content Area -->
    <div class="main-content">
        <div class="dashboard-header-card">
            <h1 class="dashboard-title">My Dashboard</h1>
            <p class="dashboard-subtitle">Welcome back! Here's what's coming up for your pets.</p>
        </div>

        <!-- Upcoming Appointments (Primary Focus) -->
        <div class="dashboard-card appointments-primary">
            <div class="section-header">
                <h2 class="section-title">üïí Upcoming Appointments</h2>
                {% if upcoming_appointments %}
                <span class="appointment-count">{{ upcoming_appointments|length }}</span>
                {% endif %}
            </div>

            {% if upcoming_appointments %}
            <div class="appointments-slider">
                {% for appt in upcoming_appointments %}
                <div class="appointment-card compact {% if forloop.first %}active{% endif %}">
                    <div class="appointment-time">
                        <div class="date">{{ appt.appointment_time|date:"M j" }}</div>
                        <div class="time">{{ appt.appointment_time|time:"H:i" }}</div>
                        <div class="day">{{ appt.appointment_time|date:"D" }}</div>
                    </div>
                    <div class="appointment-info">
                        <div class="pet-service">
                            <strong>{{ appt.pet_profile.name }}</strong> - {{ appt.service.name }}
                        </div>
                        <div class="status-line">
                            <span class="status-badge {{ appt.status }}">{{ appt.status|title }}</span>
                            {% if appt.assigned_employee %}
                            <span class="employee">with
                                {{ appt.assigned_employee.user.get_full_name|default:appt.assigned_employee.user.username }}</span>
                            {% endif %}
                        </div>
                        <div class="appointment-actions">
                            {% if appt.can_edit %}
                            <a href="{% url 'edit_appointment' appt.id %}" class="btn-edit-small"
                                title="Edit appointment ({{ appt.edit_count }}/3 edits used)">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            {% endif %}
                            {% if appt.can_cancel %}
                            <a href="{% url 'cancel_appointment' appt.id %}" class="btn-cancel-small">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            {% elif not appt.can_cancel and appt.status == 'approved' %}
                            <span class="cancel-warning-text">Cannot modify within 24h</span>
                            {% endif %}
                            {% if not appt.can_edit and appt.status in 'pending,approved' and appt.edit_count >= 3 %}
                            <span class="edit-limit-text" title="Maximum edits reached">
                                Edit limit reached
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if upcoming_appointments|length > 1 %}
            <div class="slider-controls">
                <button class="slider-prev">‚Äπ</button>
                <div class="slider-dots">
                    {% for appt in upcoming_appointments %}
                    <span class="dot {% if forloop.first %}active{% endif %}"
                        onclick="showAppointment({{ forloop.counter0 }})"></span>
                    {% endfor %}
                </div>
                <button class="slider-next">‚Ä∫</button>
            </div>
            {% endif %}
            {% else %}
            <div class="empty-appointments">
                <p>No upcoming appointments</p>
                <a href="{% url 'book_appointment' %}" class="btn btn-primary">Book Your First Appointment</a>
            </div>
            {% endif %}
        </div>

        <!-- Past Appointments (Collapsed by default) -->
        {% if past_appointments %}
        <div class="past-appointments-section">
            <button class="section-toggle" data-target="past">
                <span>üìã Past Appointments ({{ past_appointments|length }})</span>
                <span class="toggle-icon">‚ñº</span>
            </button>
            <div class="past-appointments-content hidden-content">
                {% for appt in past_appointments|slice:":5" %}
                <div class="appointment-card past compact">
                    <div class="appointment-time small">
                        {{ appt.appointment_time|date:"M j" }}
                    </div>
                    <div class="appointment-info">
                        <div class="pet-service">{{ appt.pet_profile.name }} - {{ appt.service.name }}</div>
                        <div class="status-line">
                            {% if appt.status == 'approved' or appt.status == 'completed' %}
                            <span class="completed-message">Thanks for your business! üêæ</span>
                            {% else %}
                            {{ appt.status|title }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if past_appointments|length > 5 %}
                <div class="show-more">
                    <button class="btn-link">Show {{ past_appointments|length|add:"-5" }} more...</button>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Rejected Appointments (Collapsed by default) -->
        {% if rejected_appointments %}
        <div class="rejected-appointments-section">
            <button class="section-toggle" data-target="rejected">
                <span>‚ùå Rejected Appointments ({{ rejected_appointments|length }})</span>
                <span class="toggle-icon-rejected">‚ñº</span>
            </button>
            <div class="rejected-appointments-content hidden-content">
                {% for appt in rejected_appointments|slice:":5" %}
                <div class="appointment-card rejected compact">
                    <div class="appointment-time small rejected">
                        {{ appt.appointment_time|date:"M j" }}
                    </div>
                    <div class="appointment-info">
                        <div class="pet-service">{{ appt.pet_profile.name }} - {{ appt.service.name }}</div>
                        <div class="status-line">
                            <span class="status-badge rejected">Rejected</span>
                            <span class="rejection-note">Reason will be shown here in future</span>
                        </div>
                        <div class="appointment-detail">
                            <small class="requested-time">Requested: {{ appt.appointment_time|date:"D, M j, Y" }} at
                                {{ appt.appointment_time|time:"H:i" }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if rejected_appointments|length > 5 %}
                <div class="show-more">
                    <button class="btn-link">Show {{ rejected_appointments|length|add:"-5" }} more...</button>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Quick Actions (Priority) -->
        <div class="dashboard-card sidebar-card priority">
            <h3 class="section-title">‚ö° Quick Actions</h3>
            <div class="quick-actions-compact">
                <a href="{% url 'book_appointment' %}" class="action-button primary">
                    <span class="icon">üìÖ</span>
                    <span class="text">Book Appointment</span>
                </a>
                <a href="{% url 'add_pet' %}" class="action-button secondary">
                    <span class="icon">üêï</span>
                    <span class="text">Add Pet</span>
                </a>
            </div>
        </div>

        <!-- My Pets -->
        <div class="dashboard-card sidebar-card">
            <h3 class="section-title">üêæ My Pets</h3>
            {% if pets %}
            <div class="pets-compact">
                {% for pet in pets %}
                <div class="pet-item-compact">
                    <div class="pet-info">
                        <div class="pet-name">{{ pet.name }}</div>
                        <div class="pet-breed">{{ pet.breed }}</div>
                        <div class="pet-actions">
                            <a href="{% url 'edit_pet' pet.id %}" class="pet-action-btn edit"
                                title="Edit Details">‚úèÔ∏è</a>
                        </div>
                    </div>
                    <div class="pet-status-badge {{ pet.profile_status }}">
                        {{ pet.profile_status|title }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="empty-text">No pets added yet</p>
            <a href="{% url 'add_pet' %}" class="btn-link">Add your first pet ‚Üí</a>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'core/js/base.js' %}?v=16.0"></script>
<script src="{% static 'core/js/client-dashboard-simple.js' %}?v=16.0"></script>
{% endblock %}