{% extends 'core/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Pet Management - Dog Booking System{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>Pet Management</h1>
    <p class="dashboard-subtitle">Review pet registrations and manage all pets</p>
</div>

<!-- Tabs for navigation -->
<div class="tabs-container">
    <div class="tabs">
        <button class="tab-button active" data-tab="pending">Pending Approvals</button>
        <button class="tab-button" data-tab="all-pets">All Pets</button>
    </div>
</div>

<!-- Pending Pets Tab -->
<div id="pending-tab" class="tab-content active">
    {% if pet_forms %}
    <div class="pets-grid">
        {% for pet, form in pet_forms %}
        <div class="pet-card">
            <div class="pet-info">
                <h3>{{ pet.name }}</h3>
                <div class="pet-details">
                    <div class="pet-detail-item">
                        <strong>Breed:</strong> {{ pet.breed }}
                    </div>
                    <div class="pet-detail-item">
                        <strong>Owner:</strong> {{ pet.user.username }}
                    </div>
                    <div class="pet-detail-item">
                        <strong>Date of Birth:</strong> {{ pet.date_of_birth }}
                    </div>
                    {% if pet.grooming_preferences %}
                    <div class="pet-detail-item">
                        <strong>Grooming Preferences:</strong> {{ pet.grooming_preferences }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <form method="post" class="pet-approval-form action-form" data-pet-id="{{ pet.id }}">
                {% csrf_token %}
                <div class="form-group">
                    {{ form.size.label_tag }}
                    {{ form.size|add_class:"form-control" }}
                    {{ form.decision|add_class:"hidden" }}
                </div>

                <input type="hidden" name="pet_id" value="{{ pet.id }}">

                <div class="pet-actions">
                    <button type="submit" name="{{ form.prefix }}-decision" value="approve"
                        class="btn btn-success approve-btn" disabled>
                        ✅ Approve
                    </button>
                    <button type="submit" name="{{ form.prefix }}-decision" value="reject" class="btn btn-danger">
                        ❌ Reject
                    </button>
                </div>
            </form>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <h3>No Pending Pet Profiles</h3>
        <p>All pet registrations have been reviewed.</p>
    </div>
    {% endif %}
</div>

<!-- All Pets Tab -->
<div id="all-pets-tab" class="tab-content">
    {% if all_pets %}
    <div class="pets-list">
        <div class="list-header">
            <h3>All Registered Pets ({{ all_pets.count }})</h3>
            <div class="search-container">
                <input type="text" id="pet-search" placeholder="Search pets by name, breed, or owner..."
                    class="form-control">
            </div>
        </div>

        <div class="collapsible-list">
            {% for pet in all_pets %}
            <div class="collapsible-item"
                data-search-content="{{ pet.name|lower }} {{ pet.breed|lower }} {{ pet.user.username|lower }}">
                <div class="collapsible-header" data-pet-id="{{ pet.id }}">
                    <div class="pet-summary">
                        <div class="pet-name-status">
                            <h4>{{ pet.name }}</h4>
                            <span class="status-badge verified">{{ pet.status|title }}</span>
                        </div>
                        <div class="pet-basic-info">
                            <span class="pet-breed">{{ pet.breed }}</span>
                            <span class="pet-owner">Owner: {{ pet.user.username }}</span>
                            {% if pet.size %}
                            <span class="pet-size">{{ pet.size|title }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <button class="collapse-toggle" type="button">
                        <span class="toggle-icon">▼</span>
                    </button>
                </div>

                <div class="collapsible-content">
                    <div class="pet-detailed-info">
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Date of Birth:</label>
                                <span>{{ pet.date_of_birth|date:"M d, Y" }}</span>
                            </div>
                            <div class="info-item">
                                <label>Age:</label>
                                <span>
                                    {% now "Y" as current_year %}
                                    {% with pet.date_of_birth.year as birth_year %}
                                    {{ current_year|add:0|add:birth_year|add:"-2000" }} years old
                                    {% endwith %}
                                </span>
                            </div>
                            <div class="info-item">
                                <label>Registered:</label>
                                <span>{{ pet.created_at|date:"M d, Y" }}</span>
                            </div>
                            <div class="info-item">
                                <label>Last Updated:</label>
                                <span>{{ pet.updated_at|date:"M d, Y" }}</span>
                            </div>
                        </div>

                        {% if pet.grooming_preferences %}
                        <div class="grooming-preferences">
                            <label>Grooming Preferences:</label>
                            <p>{{ pet.grooming_preferences }}</p>
                        </div>
                        {% endif %}

                        <!-- Recent Appointments -->
                        {% if pet.appointment_set.all %}
                        <div class="appointments-section">
                            <h5>Recent Appointments</h5>
                            <div class="appointments-list">
                                {% for appointment in pet.appointment_set.all|slice:":3" %}
                                <div class="appointment-item">
                                    <div class="appointment-date">
                                        {{ appointment.appointment_time|date:"M d, Y H:i" }}
                                    </div>
                                    <div class="appointment-service">
                                        {{ appointment.service.name }}
                                    </div>
                                    <div class="appointment-status">
                                        <span
                                            class="status-badge {{ appointment.status }}">{{ appointment.status|title }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                                {% if pet.appointment_set.all.count > 3 %}
                                <div class="appointment-item more-appointments">
                                    <span>+ {{ pet.appointment_set.all.count|add:"-3" }} more appointments</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="no-appointments">
                            <p>No appointments scheduled</p>
                        </div>
                        {% endif %}

                        <div class="pet-actions-detailed">
                            <div class="action-group">
                                <h5>Pet Management</h5>
                                <div class="crud-buttons">
                                    <!-- Status Update Form -->
                                    <form method="post" action="{% url 'update_pet_status' pet.id %}"
                                        class="status-form">
                                        {% csrf_token %}
                                        <label for="status-{{ pet.id }}">Status:</label>
                                        <select name="status" id="status-{{ pet.id }}" class="form-control-sm">
                                            <option value="pending"
                                                {% if pet.profile_status == 'pending' %}selected{% endif %}>Pending
                                            </option>
                                            <option value="verified"
                                                {% if pet.profile_status == 'verified' %}selected{% endif %}>Verified
                                            </option>
                                            <option value="rejected"
                                                {% if pet.profile_status == 'rejected' %}selected{% endif %}>Rejected
                                            </option>
                                        </select>
                                        <button type="submit" class="btn btn-sm btn-primary">Update</button>
                                    </form>

                                    <!-- Action Buttons -->
                                    <div class="action-buttons">
                                        <a href="{% url 'manager_edit_pet' pet.id %}" class="btn btn-sm btn-outline">
                                            ✏️ Edit Details
                                        </a>
                                        <a href="{% url 'manager_delete_pet' pet.id %}" class="btn btn-sm btn-danger"
                                            onclick="return confirm('Are you sure you want to delete this pet?')">
                                            🗑️ Delete
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <h3>No Registered Pets</h3>
        <p>No pets have been registered yet.</p>
    </div>
    {% endif %}
</div>

<div class="back-link">
    <a href="{% url 'manager_dashboard' %}" class="btn btn-secondary">⬅ Back to Dashboard</a>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Tabs styling */
    .tabs-container {
        margin-bottom: 30px;
        border-bottom: 2px solid #e5e7eb;
    }

    .tabs {
        display: flex;
        gap: 0;
    }

    .tab-button {
        padding: 12px 24px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        font-weight: 500;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .tab-button.active {
        color: #059669;
        border-bottom-color: #059669;
    }

    .tab-button:hover {
        color: #047857;
        background: #f0fdf4;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Search styling */
    .list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .search-container {
        flex: 1;
        max-width: 400px;
    }

    /* Collapsible list styling */
    .collapsible-list {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }

    .collapsible-item {
        border-bottom: 1px solid #e5e7eb;
    }

    .collapsible-item:last-child {
        border-bottom: none;
    }

    .collapsible-header {
        padding: 16px 20px;
        background: #f9fafb;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s ease;
    }

    .collapsible-header:hover {
        background: #f3f4f6;
    }

    .collapsible-header.active {
        background: #ecfdf5;
    }

    .pet-summary {
        flex: 1;
    }

    .pet-name-status {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
    }

    .pet-name-status h4 {
        margin: 0;
        color: #111827;
        font-size: 18px;
    }

    .pet-basic-info {
        display: flex;
        gap: 16px;
        color: #6b7280;
        font-size: 14px;
    }

    .pet-basic-info span {
        display: flex;
        align-items: center;
    }

    .collapse-toggle {
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .collapse-toggle:hover {
        background: #e5e7eb;
        color: #374151;
    }

    .toggle-icon {
        transition: transform 0.3s ease;
        font-size: 12px;
    }

    .collapsible-header.active .toggle-icon {
        transform: rotate(180deg);
    }

    .collapsible-content {
        padding: 0 20px;
        max-height: 0;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .collapsible-content.active {
        padding: 20px;
        max-height: 1000px;
    }

    .pet-detailed-info {
        background: #ffffff;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .info-item label {
        font-weight: 600;
        color: #374151;
        font-size: 14px;
    }

    .info-item span {
        color: #6b7280;
    }

    .grooming-preferences {
        margin-bottom: 20px;
        padding: 16px;
        background: #f9fafb;
        border-radius: 6px;
    }

    .grooming-preferences label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
    }

    .grooming-preferences p {
        margin: 0;
        color: #6b7280;
        line-height: 1.5;
    }

    .appointments-section h5 {
        color: #374151;
        margin-bottom: 12px;
        font-size: 16px;
    }

    .appointments-list {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        overflow: hidden;
    }

    .appointment-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
    }

    .appointment-item:last-child {
        border-bottom: none;
    }

    .appointment-item.more-appointments {
        background: #f9fafb;
        font-style: italic;
        color: #6b7280;
        justify-content: center;
    }

    .appointment-date {
        font-weight: 500;
        color: #374151;
        min-width: 140px;
    }

    .appointment-service {
        flex: 1;
        color: #6b7280;
    }

    .no-appointments {
        padding: 20px;
        text-align: center;
        color: #9ca3af;
        font-style: italic;
        background: #f9fafb;
        border-radius: 6px;
    }

    .pet-actions-detailed {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
    }

    .action-group h5 {
        color: #374151;
        margin-bottom: 16px;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .crud-buttons {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .status-form {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background: #f9fafb;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
    }

    .status-form label {
        font-weight: 500;
        color: #374151;
        font-size: 14px;
        margin: 0;
    }

    .form-control-sm {
        padding: 6px 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 13px;
        min-width: 100px;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 4px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background: #059669;
        color: white;
    }

    .btn-primary:hover {
        background: #047857;
    }

    .btn-outline {
        background: white;
        color: #374151;
        border: 1px solid #d1d5db;
    }

    .btn-outline:hover {
        background: #f9fafb;
        color: #374151;
        text-decoration: none;
    }

    .btn-danger {
        background: #dc2626;
        color: white;
    }

    .btn-danger:hover {
        background: #b91c1c;
        color: white;
        text-decoration: none;
    }

    /* Status badges */
    .status-badge.verified {
        background: #d1fae5;
        color: #047857;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-badge.pending {
        background: #fef3c7;
        color: #d97706;
    }

    .status-badge.confirmed {
        background: #dbeafe;
        color: #1d4ed8;
    }

    .status-badge.completed {
        background: #d1fae5;
        color: #047857;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .pet-basic-info {
            flex-direction: column;
            gap: 8px;
        }

        .appointment-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .appointment-date {
            min-width: auto;
        }

        .info-grid {
            grid-template-columns: 1fr;
        }

        .list-header {
            flex-direction: column;
            align-items: stretch;
        }

        .search-container {
            max-width: none;
        }

        .status-form {
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
        }

        .action-buttons {
            flex-direction: column;
        }

        .crud-buttons {
            gap: 12px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'core/js/base.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Tab functionality
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active from all tabs
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // Add active to clicked tab
                button.classList.add('active');
                const targetTab = button.getAttribute('data-tab');
                document.getElementById(targetTab + '-tab').classList.add('active');
            });
        });

        // Collapsible functionality
        const collapsibleHeaders = document.querySelectorAll('.collapsible-header');

        collapsibleHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const isActive = header.classList.contains('active');

                if (isActive) {
                    header.classList.remove('active');
                    content.classList.remove('active');
                } else {
                    header.classList.add('active');
                    content.classList.add('active');
                }
            });
        });

        // Search functionality
        const searchInput = document.getElementById('pet-search');
        if (searchInput) {
            searchInput.addEventListener('input', function () {
                const searchTerm = this.value.toLowerCase();
                const items = document.querySelectorAll('.collapsible-item');

                items.forEach(item => {
                    const searchContent = item.getAttribute('data-search-content');
                    if (searchContent.includes(searchTerm)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // Pet approval form functionality (for pending tab)
        document.querySelectorAll('.pet-approval-form').forEach(form => {
            const sizeSelect = form.querySelector('select');
            const approveBtn = form.querySelector('.approve-btn');

            if (sizeSelect && approveBtn) {
                sizeSelect.addEventListener('change', () => {
                    approveBtn.disabled = !sizeSelect.value;
                });
            }
        });
    });
</script>
{% endblock %}