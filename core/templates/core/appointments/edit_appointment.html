{% extends 'core/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Edit Appointment - Dog Booking System{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'core/css/forms.css' %}">
{% endblock %}

{% block content %}
<div class="form-container">
    <h2>Edit Appointment</h2>
    <p class="dashboard-subtitle">
        Modify your appointment details - changes require re-approval
    </p>

    <div class="edit-info">
        <div class="current-appointment">
            <h3>Current Appointment Details</h3>
            <div class="appointment-details">
                <div class="detail-item">
                    <strong>Pet:</strong> {{ appointment.pet_profile.name }}
                </div>
                <div class="detail-item">
                    <strong>Current Service:</strong> {{ appointment.service.name }}
                </div>
                <div class="detail-item">
                    <strong>Current Time:</strong>
                    {{ appointment.appointment_time|date:"D, M j, Y" }} at
                    {{ appointment.appointment_time|time:"H:i" }}
                </div>
                <div class="detail-item">
                    <strong>Status:</strong> {{ appointment.status|title }}
                </div>
                <div class="detail-item">
                    <strong>Edits Used:</strong> {{ appointment.edit_count }}/3
                </div>
                {% if edits_remaining > 0 %}
                <div class="detail-item">
                    <strong>Edits Remaining:</strong> {{ edits_remaining }}
                </div>
                {% else %}
                <div class="detail-item warning">
                    <strong>⚠️ Final Edit:</strong> This is your last allowed edit
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <form method="post" class="booking-form">
        {% csrf_token %}

        <div class="form-row">
            <div class="form-group">
                {{ form.pet_profile.label_tag }}
                {{ form.pet_profile|add_class:"form-control readonly-field" }}
                <div class="form-help">Cannot be changed when editing</div>
            </div>

            <div class="form-group">
                {{ form.service.label_tag }}
                {{ form.service|add_class:"form-control" }}
            </div>
        </div>

        <div class="price-display-container">
            <div id="price-display" class="price-display">
                <strong>Price:</strong> Loading...
            </div>
        </div>

        <div class="calendar-container">
            <h3>Select New Time Slot</h3>
            <div id="calendar"></div>
        </div>

        {{ form.time_slot|add_class:"hidden" }}

        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submit-btn">
                <i class="fas fa-save"></i> Update Appointment
            </button>
            <a href="{% url 'client_dashboard' %}" class="btn btn-secondary" aria-label="Cancel Edit">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="{% static 'core/js/appointment-booking.js' %}"></script>
<script>
    // Set up URLs and options for the booking JavaScript
    window.bookingUrls = {
        available_slots: "/ajax/available-slots/",
        get_price: "/ajax/get-service-price/"
    };

    window.bookingOptions = {
        isEditMode: true,
        currentAppointmentTime: '{{ appointment.appointment_time|date:"c" }}'
    };
</script>
{% endblock %}