{% extends 'core/base.html' %}
{% load static %}

{% block title %}Appointments Dashboard - Manager{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'core/css/appointments.css' %}">
{% endblock %}

{% block content %}
<h1>Appointments Dashboard</h1>

<h2>Pending Appointments</h2>
<p class="dashboard-intro">
    ⏰ Ordered by appointment time - most urgent first
</p>
{% if appointment_forms %}
{% for appointment, form in appointment_forms %}
<div class="appointment-card-dashboard">
    <h3>{{ appointment.pet_profile.name }} - {{ appointment.service.name }}</h3>
    <p><strong>Time:</strong> {{ appointment.appointment_time }}</p>
    <p><strong>Client:</strong>
        {{ appointment.pet_profile.user.get_full_name|default:appointment.pet_profile.user.username }}</p>

    <form method="post" class="appointment-form appointment-approval-form">
        {% csrf_token %}
        {{ form.as_p }}
        <input type="hidden" name="appointment_id" value="{{ appointment.id }}">
        <button type="submit" name="decision" value="approve" class="approve-btn" disabled>✅
            Approve</button>
        <button type="submit" name="decision" value="reject" class="reject-btn">❌
            Reject</button>
    </form>
</div>
{% endfor %}
{% else %}
<p>No pending appointments to review.</p>
{% endif %}

<hr>

<h2>All Appointments - Calendar View</h2>

<!-- Employee Filter -->
<div class="employee-filter-section">
    <label for="employee-filter"><strong>Filter by Employee:</strong></label>
    <select id="employee-filter" class="employee-filter">
        <option value="all">All Employees</option>
        {% for employee in all_employees %}
        <option value="{{ employee.id }}">{{ employee.user.get_full_name|default:employee.user.username }}</option>
        {% endfor %}
    </select>
</div>

<!-- FullCalendar Container -->
<div id="calendar" class="calendar-section"></div>

<!-- Rejected Appointments Section -->
{% if rejected_appointments %}
<hr class="rejected-appointments-divider">
<h2 class="rejected-appointments-title">Rejected Appointments</h2>
<div class="rejected-appointments-container">
    {% for appointment in rejected_appointments %}
    <div class="rejected-appointment-card">
        <div class="rejected-appointment-header">
            <div>
                <h4 class="rejected-appointment-title">{{ appointment.pet_profile.name }} -
                    {{ appointment.service.name }}</h4>
                <p class="rejected-appointment-detail"><strong>Client:</strong>
                    {{ appointment.pet_profile.user.get_full_name|default:appointment.pet_profile.user.username }}</p>
                <p class="rejected-appointment-detail"><strong>Scheduled Time:</strong>
                    {{ appointment.appointment_time|date:"M d, Y \a\t g:i A" }}</p>
                <p class="rejected-appointment-detail"><strong>Service Duration:</strong>
                    {{ appointment.service.duration }}</p>
            </div>
            <div class="rejected-appointment-actions">
                <span class="rejected-status-badge">REJECTED</span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Modal for Appointment Details -->
<div id="appointmentModal" class="appointment-modal">
    <div class="appointment-modal-content">
        <span id="closeModal" class="modal-close-btn">&times;</span>
        <h3>Appointment Details</h3>
        <div id="modalContent"></div>
        <div id="modalActions" class="modal-actions"></div>
    </div>
</div>

<a href="{% url 'manager_dashboard' %}" class="dashboard-nav-link">⬅
    Back to Dashboard</a>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
<script src="{% static 'core/js/calendar-colors.js' %}"></script>
<script src="{% static 'core/js/appointments-dashboard.js' %}"></script>
<script src="{% static 'core/js/ui-components.js' %}"></script>

<script>
    // Set up URLs for the dashboard JavaScript
    window.dashboardUrls = {
        calendar_events: "{% url 'get_calendar_events' %}",
        available_employees: "{% url 'get_available_employees' %}",
        approve_appointment: "{% url 'approve_appointment_ajax' %}",
        reject_appointment: "{% url 'reject_appointment_ajax' %}",
        reassign_appointment: "{% url 'reassign_appointment_ajax' %}"
    };
</script>
{% endblock %}