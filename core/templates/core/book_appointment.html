{% extends 'core/base.html' %}

{% block content %}
<h1>Book a Grooming Appointment</h1>

{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <li>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

<form method="post">
    {% csrf_token %}
    <p>
        {{ form.pet_profile.label_tag }} {{ form.pet_profile }}
    </p>
    <p>
        {{ form.service.label_tag }} {{ form.service }}
    </p>

    <p id="price-display"><strong>Price:</strong> Please choose your pet and service first!</p>

    <div id="calendar" style="max-width: 700px; margin-top: 30px;"></div>

    {{ form.time_slot }}

    <p>
        {{ form.voucher_code.label_tag }} {{ form.voucher_code }}
    </p>

    <button type="submit">ðŸ“… Book</button>
</form>

<br>
<a href="{% url 'client_dashboard' %}">â¬… Back to Dashboard</a>

<!-- FullCalendar CDN -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const serviceField = document.getElementById("id_service");
        const timeSlotInput = document.getElementById("id_time_slot");

        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            allDaySlot: false,
            selectable: true,
            slotMinTime: "09:00:00",
            slotMaxTime: "18:01:00",
            timeZone: 'UTC',
            hiddenDays: [0], // Sundays closed!
            events: function (info, successCallback, failureCallback) {
                const serviceId = serviceField.value;
                if (!serviceId) return;

                fetch(
                        `/ajax/available-slots/?service_id=${serviceId}&start=${info.startStr}&end=${info.endStr}`
                    )
                    .then(response => response.json())
                    .then(data => {
                        successCallback(data); // FullCalendar renders them
                    })
                    .catch(error => {
                        console.error("Error loading slots:", error);
                        failureCallback(error);
                    });
            },
            eventClick: function (info) {
                timeSlotInput.value = info.event.start.toISOString(); // full ISO datetime
                calendar.getEvents().forEach(e => e.setProp('backgroundColor', '#3788d8'));
                info.event.setProp('backgroundColor', 'green');
            }
        });

        calendar.render();

        // Refetch slots when service changes
        serviceField.addEventListener("change", () => calendar.refetchEvents());
    });

    const petField = document.getElementById("id_pet_profile");
    const serviceField = document.getElementById("id_service");
    const priceDisplay = document.getElementById("price-display");

    function updatePrice() {
        const petId = petField.value;
        const serviceId = serviceField.value;

        if (!petId || !serviceId) {
            priceDisplay.innerHTML = "<strong>Price:</strong> Please choose your pet and service first!";
            return;
        }

        fetch(`/ajax/get-service-price/?pet_id=${petId}&service_id=${serviceId}`)
            .then(response => response.json())
            .then(data => {
                if (data.price) {
                    priceDisplay.innerHTML = `<strong>Price:</strong> Â£${data.price}`;
                } else {
                    priceDisplay.innerHTML = "<strong>Price:</strong> Not available for this selection.";
                }
            })
            .catch(error => {
                priceDisplay.innerHTML = "<strong>Price:</strong> Error fetching price.";
            });
    }

    petField.addEventListener("change", updatePrice);
    serviceField.addEventListener("change", updatePrice);
</script>
{% endblock %}