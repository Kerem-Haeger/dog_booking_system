{% extends 'core/base.html' %}
{% load static %}

{% block title %}Appointments Dashboard - Manager{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'core/css/appointments.css' %}">
{% endblock %}

{% block content %}
<h1>Appointments Dashboard</h1>

<h2>Pending Appointments</h2>
<p class="dashboard-intro">
    ⏰ Ordered by appointment time - most urgent first
</p>
{% if appointment_forms %}
{% for appointment, form in appointment_forms %}
<div class="appointment-card-dashboard">
    <h3>{{ appointment.pet_profile.name }} - {{ appointment.service.name }}</h3>
    <p><strong>Time:</strong> {{ appointment.appointment_time }}</p>
    <p><strong>Client:</strong>
        {{ appointment.pet_profile.user.get_full_name|default:appointment.pet_profile.user.username }}</p>

    <form method="post" class="appointment-form">
        {% csrf_token %}
        {{ form.as_p }}
        <input type="hidden" name="appointment_id" value="{{ appointment.id }}">
        <button type="submit" name="decision" value="approve" class="approve-btn">✅
            Approve</button>
        <button type="submit" name="decision" value="reject" class="reject-btn">❌
            Reject</button>
    </form>
</div>
{% endfor %}
{% else %}
<p>No pending appointments to review.</p>
{% endif %}

<hr>

<h2>All Appointments - Calendar View</h2>

<!-- Employee Filter -->
<div class="employee-filter-section">
    <label for="employee-filter"><strong>Filter by Employee:</strong></label>
    <select id="employee-filter" class="employee-filter">
        <option value="all">All Employees</option>
        {% for employee in all_employees %}
        <option value="{{ employee.id }}">{{ employee.user.get_full_name|default:employee.user.username }}</option>
        {% endfor %}
    </select>
</div>

<!-- FullCalendar Container -->
<div id="calendar" class="calendar-section"></div>

<!-- Rejected Appointments Section -->
{% if rejected_appointments %}
<hr class="rejected-appointments-divider">
<h2 class="rejected-appointments-title">Rejected Appointments</h2>
<div class="rejected-appointments-container">
    {% for appointment in rejected_appointments %}
    <div class="rejected-appointment-card">
        <div class="rejected-appointment-header">
            <div>
                <h4 class="rejected-appointment-title">{{ appointment.pet_profile.name }} -
                    {{ appointment.service.name }}</h4>
                <p class="rejected-appointment-detail"><strong>Client:</strong>
                    {{ appointment.pet_profile.user.get_full_name|default:appointment.pet_profile.user.username }}</p>
                <p class="rejected-appointment-detail"><strong>Scheduled Time:</strong>
                    {{ appointment.appointment_time|date:"M d, Y \a\t g:i A" }}</p>
                <p class="rejected-appointment-detail"><strong>Service Duration:</strong>
                    {{ appointment.service.duration }}</p>
            </div>
            <div class="rejected-appointment-actions">
                <span class="rejected-status-badge">REJECTED</span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Modal for Appointment Details -->
<div id="appointmentModal" class="appointment-modal">
    <div class="appointment-modal-content">
        <span id="closeModal" class="modal-close-btn">&times;</span>
        <h3>Appointment Details</h3>
        <div id="modalContent"></div>
        <div id="modalActions" class="modal-actions"></div>
    </div>
</div>

<a href="{% url 'manager_dashboard' %}" class="dashboard-nav-link">⬅
    Back to Dashboard</a>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
<script src="{% static 'core/js/calendar-colors.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize color manager for client-side performance optimization
        var colorManager = new CalendarColorManager();

        var calendarEl = document.getElementById('calendar');
        var employeeFilter = document.getElementById('employee-filter');
        var modal = document.getElementById('appointmentModal');
        var closeModal = document.getElementById('closeModal');
        var modalContent = document.getElementById('modalContent');
        var modalActions = document.getElementById('modalActions');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            headerToolbar: {
                left: 'prev,next',
                center: 'title',
                right: ''
            },
            hiddenDays: [0], // Hide Sunday (0 = Sunday)
            slotMinTime: '08:00:00',
            slotMaxTime: '18:00:00',
            timeZone: 'UTC',
            allDaySlot: false,
            height: 'auto',
            events: function (fetchInfo, successCallback, failureCallback) {
                var employeeId = employeeFilter.value;

                fetch(
                        `{% url 'get_calendar_events' %}?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}&employee_id=${employeeId}`
                    )
                    .then(response => response.json())
                    .then(data => {
                        // Apply colors client-side for better performance
                        try {
                            var coloredEvents = colorManager.processCalendarEvents(data);
                            successCallback(coloredEvents);
                        } catch (error) {
                            console.error('Error processing calendar colors:', error);
                            // Fallback: use raw data without colors
                            successCallback(data);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching events:', error);
                        failureCallback(error);
                    });
            },
            eventClick: function (info) {
                var event = info.event;
                var props = event.extendedProps;

                // Show appointment details
                modalContent.innerHTML = `
                <p><strong>Pet:</strong> ${props.pet_name}</p>
                <p><strong>Service:</strong> ${props.service}</p>
                <p><strong>Employee:</strong> ${props.employee}</p>
                <p><strong>Client:</strong> ${props.client}</p>
                <p><strong>Time:</strong> ${event.start.toLocaleString()}</p>
                <p><strong>Status:</strong> <span style="color: ${event.backgroundColor}; font-weight: bold;">${props.status.toUpperCase()}</span></p>
                <div id="employeeSection" style="margin-top: 15px;"></div>
                <div id="loadingIndicator" style="display: none; text-align: center; margin: 10px 0;">
                    <span>Loading...</span>
                </div>
                <div id="messageArea" style="margin-top: 10px;"></div>
            `;

                // Load available employees and show appropriate actions
                loadEmployeesAndActions(props.appointment_id, props.status);

                modal.style.display = 'block';
            }
        });

        calendar.render();

        // Refresh calendar when employee filter changes
        employeeFilter.addEventListener('change', function () {
            calendar.refetchEvents();
        });

        // Close modal functionality
        closeModal.onclick = function () {
            modal.style.display = 'none';
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Functions for AJAX appointment management
        window.loadEmployeesAndActions = function (appointmentId, status) {
            var employeeSection = document.getElementById('employeeSection');
            var loadingIndicator = document.getElementById('loadingIndicator');

            loadingIndicator.style.display = 'block';

            // Fetch available employees
            fetch(`{% url 'get_available_employees' %}?appointment_id=${appointmentId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('DEBUG: Employee data received:', data);
                    loadingIndicator.style.display = 'none';

                    if (data.success) {
                        if (status === 'pending') {
                            // Show employee dropdown for pending appointments
                            var employeeOptions = data.employees.map(emp =>
                                `<option value="${emp.id}">${emp.name}</option>`
                            ).join('');

                            employeeSection.innerHTML = `
                                <label for="employeeSelect"><strong>Assign to Employee:</strong></label>
                                <select id="employeeSelect" style="width: 100%; padding: 5px; margin: 5px 0;">
                                    <option value="">Select an employee...</option>
                                    ${employeeOptions}
                                </select>
                                <p style="font-size: 0.9rem; color: #6c757d; margin: 5px 0;">Employee assignment is only required for approval.</p>
                            `;

                            modalActions.innerHTML = `
                                <button onclick="approveAppointmentAjax(${appointmentId})" style="background: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 3px; margin-right: 10px;">✅ Approve</button>
                                <button onclick="rejectAppointmentAjax(${appointmentId})" style="background: #dc3545; color: white; padding: 8px 15px; border: none; border-radius: 3px;">❌ Reject</button>
                            `;
                        } else if (status === 'approved') {
                            // Show reassignment dropdown for approved appointments
                            console.log('DEBUG: Setting up approved appointment UI');
                            console.log('DEBUG: Available employees:', data.employees);
                            console.log('DEBUG: Current employee:', data.current_employee);

                            var employeeOptions = data.employees.map(emp => {
                                var isSelected = emp.id === data.current_employee ? 'selected' :
                                    '';
                                console.log(
                                    `DEBUG: Employee ${emp.id} (${emp.name}) - selected: ${isSelected}`
                                );
                                return `<option value="${emp.id}" ${isSelected}>${emp.name}</option>`;
                            }).join('');

                            console.log('DEBUG: Generated employee options:', employeeOptions);

                            employeeSection.innerHTML = `
                                <label for="employeeSelect"><strong>Reassign to Employee:</strong></label>
                                <select id="employeeSelect" style="width: 100%; padding: 5px; margin: 5px 0;">
                                    ${employeeOptions}
                                </select>
                            `;

                            modalActions.innerHTML = `
                                <button onclick="reassignAppointmentAjax(${appointmentId})" style="background: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 3px;">🔄 Reassign</button>
                            `;

                            console.log('DEBUG: UI setup complete for approved appointment');
                        } else {
                            // No actions for rejected/completed appointments
                            employeeSection.innerHTML = '';
                            modalActions.innerHTML = '';
                        }
                    } else {
                        showMessage('Error loading employees: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    loadingIndicator.style.display = 'none';
                    showMessage('Error loading employees: ' + error.message, 'error');
                });
        }

        window.showMessage = function (message, type) {
            var messageArea = document.getElementById('messageArea');
            var color = type === 'error' ? '#dc3545' : '#28a745';
            messageArea.innerHTML =
                `<div style="padding: 10px; background: ${color}; color: white; border-radius: 3px; margin: 5px 0;">${message}</div>`;

            // Clear message after 3 seconds
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 3000);
        }

        window.approveAppointmentAjax = function (appointmentId) {
            var employeeSelect = document.getElementById('employeeSelect');
            var employeeId = employeeSelect.value;

            if (!employeeId) {
                showMessage('Please select an employee first.', 'error');
                return;
            }

            var loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';

            // Get CSRF token
            var csrfToken = null;
            var csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfInput) {
                csrfToken = csrfInput.value;
            } else {
                csrfToken = getCookie('csrftoken');
            }

            fetch(`{% url 'approve_appointment_ajax' %}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        appointment_id: appointmentId,
                        employee_id: employeeId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    loadingIndicator.style.display = 'none';

                    if (data.success) {
                        showMessage(data.message, 'success');
                        // Update appointment color instantly (better UX than full refresh)
                        colorManager.updateAppointmentColor(calendar, appointmentId, 'approved');
                        // Close modal after 2 seconds
                        setTimeout(() => {
                            modal.style.display = 'none';
                        }, 2000);
                    } else {
                        showMessage('Error: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    loadingIndicator.style.display = 'none';
                    showMessage('Error: ' + error.message, 'error');
                });
        }

        window.rejectAppointmentAjax = function (appointmentId) {
            if (!confirm('Are you sure you want to reject this appointment?')) {
                return;
            }

            var loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';

            // Get CSRF token
            var csrfToken = null;
            var csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfInput) {
                csrfToken = csrfInput.value;
            } else {
                csrfToken = getCookie('csrftoken');
            }

            fetch(`{% url 'reject_appointment_ajax' %}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        appointment_id: appointmentId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    loadingIndicator.style.display = 'none';

                    if (data.success) {
                        showMessage(data.message, 'success');
                        // Remove rejected appointment from calendar instantly (better UX)
                        var event = calendar.getEventById(appointmentId);
                        if (event) {
                            event.remove();
                        }
                        // Close modal after 2 seconds
                        setTimeout(() => {
                            modal.style.display = 'none';
                        }, 2000);
                    } else {
                        showMessage('Error: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    loadingIndicator.style.display = 'none';
                    showMessage('Error: ' + error.message, 'error');
                });
        }

        window.reassignAppointmentAjax = function (appointmentId) {
            var employeeSelect = document.getElementById('employeeSelect');
            var employeeId = employeeSelect.value;

            console.log('DEBUG: Reassign function called', {
                appointmentId: appointmentId,
                employeeId: employeeId,
                selectElement: employeeSelect
            });

            if (!employeeId) {
                showMessage('Please select an employee.', 'error');
                return;
            }

            var loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';

            console.log('DEBUG: Sending reassign request');

            // Get CSRF token from the form in the pending appointments section
            var csrfToken = null;
            var csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfInput) {
                csrfToken = csrfInput.value;
            } else {
                // Fallback: get from cookie
                csrfToken = getCookie('csrftoken');
            }

            console.log('DEBUG: CSRF token:', csrfToken);

            fetch(`{% url 'reassign_appointment_ajax' %}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        appointment_id: appointmentId,
                        employee_id: employeeId
                    })
                })
                .then(response => {
                    console.log('DEBUG: Response received', response);
                    return response.json();
                })
                .then(data => {
                    console.log('DEBUG: Response data', data);
                    loadingIndicator.style.display = 'none';

                    if (data.success) {
                        showMessage(data.message, 'success');
                        // Refresh calendar to show updated appointment
                        calendar.refetchEvents();
                        // Close modal after 2 seconds
                        setTimeout(() => {
                            modal.style.display = 'none';
                        }, 2000);
                    } else {
                        showMessage('Error: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('DEBUG: Fetch error', error);
                    loadingIndicator.style.display = 'none';
                    showMessage('Error: ' + error.message, 'error');
                });
        }

        // Helper function to get CSRF token from cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>

<style>
    .appointment-card {
        background: #f8f9fa;
        border-left: 4px solid #ffc107;
    }

    #calendar {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
    }

    .fc-event {
        cursor: pointer;
    }

    .fc-event:hover {
        opacity: 0.8;
    }
</style>
{% endblock %}